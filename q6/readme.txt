Similar to that in q5, except for the additional usage of pool, much faster than before.